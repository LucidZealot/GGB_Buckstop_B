ame: API Testing

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'

jobs:
  api-tests:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '6.0.x'
      
      - name: Find BucStop Project
        id: find_project
        run: |
          echo "Looking for BucStop project..."
          
          BUCKSTOP_CSPROJ=$(find . -name "BucStop.csproj" | head -1)
          
          if [ -z "$BUCKSTOP_CSPROJ" ]; then
            echo "ERROR: BucStop.csproj not found!"
            exit 1
          fi
          
          BUCKSTOP_DIR=$(dirname "$BUCKSTOP_CSPROJ")
          echo "Found BucStop at: $BUCKSTOP_DIR"
          echo "buckstop_dir=$BUCKSTOP_DIR" >> $GITHUB_OUTPUT
      
      - name: Restore BucStop dependencies
        run: |
          echo "Restoring dependencies for BucStop..."
          cd "${{ steps.find_project.outputs.buckstop_dir }}"
          dotnet restore
      
      - name: Build BucStop API
        run: |
          echo "Building BucStop API..."
          cd "${{ steps.find_project.outputs.buckstop_dir }}"
          dotnet build --configuration Release --no-restore
      
      - name: Start BucStop API Server
        run: |
          echo "Starting BucStop API..."
          
          BUCKSTOP_DIR="${{ steps.find_project.outputs.buckstop_dir }}"
          
          DLL_PATH=$(find "$BUCKSTOP_DIR" -name "BucStop.dll" -path "*/bin/Release/*" | head -1)
          
          if [ -z "$DLL_PATH" ]; then
            echo "ERROR: BucStop.dll not found!"
            exit 1
          fi
          
          echo "Found DLL at: $DLL_PATH"
          DLL_DIR=$(dirname "$DLL_PATH")
          
          cd "$DLL_DIR"
          nohup dotnet BucStop.dll --urls "http://0.0.0.0:5230" > api.log 2>&1 &
          API_PID=$!
          echo $API_PID > "$GITHUB_WORKSPACE/api_pid.txt"
          echo "Started API with PID: $API_PID"
          cd "$GITHUB_WORKSPACE"
          
          echo "Waiting for BucStop API to start..."
          MAX_ATTEMPTS=30
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            if curl -s -f http://localhost:5230/ > /dev/null 2>&1; then
              echo "BucStop API is up and running!"
              sleep 2
              break
            fi
            
            ATTEMPT=$((ATTEMPT + 1))
            echo "Waiting for API... (Attempt $ATTEMPT/$MAX_ATTEMPTS)"
            sleep 2
          done
          
          if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
            echo "ERROR: API failed to start within timeout"
            cat "$DLL_DIR/api.log" 2>/dev/null || echo "No log file found"
            exit 1
          fi
        env:
          ASPNETCORE_ENVIRONMENT: Development
      
      - name: Test Main API Endpoints
        run: |
          echo "=========================================="
          echo "Testing BucStop API Endpoints"
          echo "=========================================="
          
          ALL_PASSED=true
          
          # Test Home endpoint (public, no auth required)
          echo ""
          echo "Testing Home (/)..."
          response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5230/)
          time=$(curl -o /dev/null -s -w '%{time_total}' http://localhost:5230/)
          if [ "$response" -eq 200 ]; then
            echo "   Status: $response | Response time: ${time}s"
          else
            echo "   Status: $response | Response time: ${time}s"
            ALL_PASSED=false
          fi
          
          # Test Games endpoint (accept 302 redirect - requires authentication)
          echo ""
          echo "Testing Games (/Games) - expecting redirect..."
          response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5230/Games)
          time=$(curl -o /dev/null -s -w '%{time_total}' http://localhost:5230/Games)
          
          # Accept both 200 (if logged in) and 302 (redirect to login)
          if [ "$response" -eq 200 ] || [ "$response" -eq 302 ]; then
            echo "   Status: $response | Response time: ${time}s"
          else
            echo "   Status: $response | Response time: ${time}s (unexpected status)"
            ALL_PASSED=false
          fi
          
          # Test Swagger endpoint (if available)
          echo ""
          echo "Testing Swagger endpoint..."
          response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5230/swagger/v1/swagger.json)
          if [ "$response" -eq 200 ]; then
            echo "   Status: $response - Swagger available"
          else
            echo "   Status: $response - Swagger not available (optional)"
          fi
          
          echo ""
          echo "=========================================="
          if [ "$ALL_PASSED" = "true" ]; then
            echo "All API tests passed!"
          else
            echo "Some endpoints failed"
            exit 1
          fi
          echo "=========================================="
      
      - name: Stop API Server
        if: always()
        run: |
          echo "Shutting down BucStop API..."
          
          if [ -f api_pid.txt ]; then
            PID=$(cat api_pid.txt)
            kill "$PID" 2>/dev/null || true
            sleep 2
            
            if ps -p "$PID" > /dev/null 2>&1; then
              kill -9 "$PID" 2>/dev/null || true
            fi
            
            echo "API stopped"
          fi
      
      - name: Show API Logs on Failure
        if: failure()
        run: |
          BUCKSTOP_DIR="${{ steps.find_project.outputs.buckstop_dir }}"
          DLL_DIR=$(find "$BUCKSTOP_DIR" -name "BucStop.dll" -path "*/bin/Release/*" -exec dirname {} \; | head -1)
          
          if [ -n "$DLL_DIR" ] && [ -f "$DLL_DIR/api.log" ]; then
            echo "API logs:"
            cat "$DLL_DIR/api.log"
          fi
      
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: api-test-results
          path: |
            **/api.log
          if-no-files-found: ignore
